<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebLogic DataSources Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-card.filtered {
            background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%);
            border-left: 4px solid #ff9800;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            transition: color 0.3s;
        }

        .stat-card.filtered .number {
            color: #ff9800;
        }

        .filter-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff9800;
            color: white;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .filters {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .filters h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-clear {
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-clear:hover {
            background: #da190b;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 20px 25px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            color: #333;
            font-size: 20px;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #45a049;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #667eea;
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #5568d3;
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.5;
        }

        th.sorted-asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
        }

        th.sorted-desc::after {
            content: ' ‚ñº';
            opacity: 1;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 5px;
            margin: 20px;
        }

        .pagination {
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls button {
            padding: 8px 15px;
            margin: 0 5px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .pagination-controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .pagination-controls button:not(:disabled):hover {
            background: #5568d3;
        }

        .url-cell {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß WebLogic DataSources Dashboard</h1>
            <p>Monitoramento de conex√µes WebLogic 10/11/12c</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>Total DataSources</h3>
                <div class="number" id="totalDS">-</div>
            </div>
            <div class="stat-card">
                <h3>Servidores</h3>
                <div class="number" id="totalServers">-</div>
            </div>
            <div class="stat-card">
                <h3>Aplica√ß√µes</h3>
                <div class="number" id="totalApps">-</div>
            </div>
            <div class="stat-card">
                <h3>Com Targets</h3>
                <div class="number" id="withTargets">-</div>
            </div>
            <div class="stat-card">
                <h3>Sem Targets</h3>
                <div class="number" id="withoutTargets">-</div>
            </div>
        </div>

        <div class="filters">
            <h2>üîç Filtros</h2>
            
            <!-- Pesquisa Global -->
            <div style="margin-bottom: 20px;">
                <div class="filter-group">
                    <label for="globalSearch">üîé Pesquisa Global</label>
                    <input type="text" id="globalSearch" placeholder="Pesquisar em todos os campos..." style="font-size: 16px; padding: 12px;">
                </div>
                <p style="color: #666; font-size: 12px; margin-top: 5px;">
                    Pesquise por servidor, datasource, JNDI, usu√°rio, targets ou URL
                </p>
            </div>

            <!-- Filtros Espec√≠ficos -->
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="filterServer">Servidor</label>
                    <input type="text" id="filterServer" placeholder="Filtrar por servidor...">
                </div>
                <div class="filter-group">
                    <label for="filterApp">Aplica√ß√£o</label>
                    <input type="text" id="filterApp" placeholder="Filtrar por aplica√ß√£o...">
                </div>
                <div class="filter-group">
                    <label for="filterVersion">Vers√£o</label>
                    <input type="text" id="filterVersion" placeholder="Filtrar por vers√£o...">
                </div>
                <div class="filter-group">
                    <label for="filterDSName">Nome DataSource</label>
                    <input type="text" id="filterDSName" placeholder="Filtrar por nome...">
                </div>
                <div class="filter-group">
                    <label for="filterJNDI">JNDI Name</label>
                    <input type="text" id="filterJNDI" placeholder="Filtrar por JNDI...">
                </div>
                <div class="filter-group">
                    <label for="filterUser">Usu√°rio</label>
                    <input type="text" id="filterUser" placeholder="Filtrar por usu√°rio...">
                </div>
                <div class="filter-group">
                    <label for="filterURL">JDBC URL</label>
                    <input type="text" id="filterURL" placeholder="Filtrar por host, porta, SID...">
                </div>
                <div class="filter-group">
                    <label for="filterTarget">Target Status</label>
                    <select id="filterTarget">
                        <option value="">Todos</option>
                        <option value="with">Com Targets</option>
                        <option value="without">Sem Targets</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn-clear" onclick="clearFilters()">Limpar Filtros</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h2>üìä DataSources</h2>
                <button class="refresh-btn" onclick="loadData()">üîÑ Atualizar</button>
            </div>
            <div class="table-wrapper">
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Carregando dados...</p>
                </div>
                <div id="error" style="display:none;"></div>
                <table id="dataTable" style="display:none;">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('server')">Servidor</th>
                            <th class="sortable" onclick="sortTable('aplicacao')">Aplica√ß√£o</th>
                            <th class="sortable" onclick="sortTable('version')">Vers√£o</th>
                            <th class="sortable" onclick="sortTable('name')">Nome DataSource</th>
                            <th class="sortable" onclick="sortTable('jndi_name')">JNDI Name</th>
                            <th class="sortable" onclick="sortTable('user')">Usu√°rio</th>
                            <th class="sortable" onclick="sortTable('targets')">Targets</th>
                            <th>JDBC URL</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="pagination" style="display:none;">
                <div class="pagination-info" id="paginationInfo"></div>
                <div class="pagination-controls">
                    <button onclick="previousPage()" id="prevBtn">Anterior</button>
                    <button onclick="nextPage()" id="nextBtn">Pr√≥xima</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let sortColumn = '';
        let sortDirection = 'asc';

        async function loadData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const table = document.getElementById('dataTable');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            table.style.display = 'none';

            try {
                const response = await fetch('http://localhost:8080/api/weblogic-datasources');
                if (!response.ok) throw new Error('Erro ao carregar dados');
                
                allData = await response.json();
                filteredData = [...allData];
                
                updateStats();
                applyFilters();
                loading.style.display = 'none';
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.className = 'error';
                error.innerHTML = `<strong>Erro:</strong> ${err.message}<br><small>Verifique se a API est√° rodando em http://localhost:8080/api/weblogic-datasources</small>`;
            }
        }

        function updateStats(dataToCount = allData) {
            const servers = new Set(dataToCount.map(item => item.server));
            const apps = new Set(dataToCount.map(item => item.aplicacao));
            const withTargets = dataToCount.filter(item => item.data_source.targets).length;
            
            document.getElementById('totalDS').textContent = dataToCount.length;
            document.getElementById('totalServers').textContent = servers.size;
            document.getElementById('totalApps').textContent = apps.size;
            document.getElementById('withTargets').textContent = withTargets;
            document.getElementById('withoutTargets').textContent = dataToCount.length - withTargets;
            
            // Adiciona/remove classe e badge quando filtros est√£o ativos
            const isFiltered = dataToCount.length < allData.length;
            const statCards = document.querySelectorAll('.stat-card');
            
            statCards.forEach(card => {
                // Remove badges antigas
                const oldBadge = card.querySelector('.filter-badge');
                if (oldBadge) oldBadge.remove();
                
                if (isFiltered) {
                    card.classList.add('filtered');
                    // Adiciona badge "FILTRADO"
                    const badge = document.createElement('span');
                    badge.className = 'filter-badge';
                    badge.textContent = 'Filtrado';
                    card.appendChild(badge);
                } else {
                    card.classList.remove('filtered');
                }
            });
        }

        function applyFilters() {
            const globalSearch = document.getElementById('globalSearch').value.toLowerCase();
            const serverFilter = document.getElementById('filterServer').value.toLowerCase();
            const appFilter = document.getElementById('filterApp').value.toLowerCase();
            const versionFilter = document.getElementById('filterVersion').value.toLowerCase();
            const dsNameFilter = document.getElementById('filterDSName').value.toLowerCase();
            const jndiFilter = document.getElementById('filterJNDI').value.toLowerCase();
            const userFilter = document.getElementById('filterUser').value.toLowerCase();
            const urlFilter = document.getElementById('filterURL').value.toLowerCase();
            const targetFilter = document.getElementById('filterTarget').value;

            filteredData = allData.filter(item => {
                // Pesquisa global - busca em todos os campos
                let matchGlobal = true;
                if (globalSearch) {
                    const searchIn = [
                        item.server,
                        item.aplicacao || '',
                        item.version || '',
                        item.data_source.name,
                        item.data_source.jndi_name,
                        item.data_source.user,
                        item.data_source.targets,
                        item.data_source.jdbc_url
                    ].join(' ').toLowerCase();
                    
                    matchGlobal = searchIn.includes(globalSearch);
                }

                // Filtros espec√≠ficos
                const matchServer = item.server.toLowerCase().includes(serverFilter);
                const matchApp = (item.aplicacao || '').toLowerCase().includes(appFilter);
                const matchVersion = (item.version || '').toLowerCase().includes(versionFilter);
                const matchDSName = item.data_source.name.toLowerCase().includes(dsNameFilter);
                const matchJNDI = item.data_source.jndi_name.toLowerCase().includes(jndiFilter);
                const matchUser = item.data_source.user.toLowerCase().includes(userFilter);
                const matchURL = item.data_source.jdbc_url.toLowerCase().includes(urlFilter);
                
                let matchTarget = true;
                if (targetFilter === 'with') matchTarget = item.data_source.targets !== '';
                if (targetFilter === 'without') matchTarget = item.data_source.targets === '';

                return matchGlobal && matchServer && matchApp && matchVersion && matchDSName && matchJNDI && matchUser && matchURL && matchTarget;
            });

            currentPage = 1;
            updateStats(filteredData); // Atualiza os cards com dados filtrados
            renderTable();
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            filteredData.sort((a, b) => {
                let aVal, bVal;
                
                if (column === 'server') {
                    aVal = a.server;
                    bVal = b.server;
                } else if (column === 'aplicacao') {
                    aVal = a.aplicacao || '';
                    bVal = b.aplicacao || '';
                } else if (column === 'version') {
                    aVal = a.version || '';
                    bVal = b.version || '';
                } else {
                    aVal = a.data_source[column] || '';
                    bVal = b.data_source[column] || '';
                }

                if (sortDirection === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });

            updateSortIcons();
            renderTable();
        }

        function updateSortIcons() {
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            const headers = document.querySelectorAll('th');
            const columnIndex = ['server', 'aplicacao', 'version', 'name', 'jndi_name', 'user', 'targets'].indexOf(sortColumn);
            
            if (columnIndex !== -1) {
                headers[columnIndex].classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const table = document.getElementById('dataTable');
            const pagination = document.getElementById('pagination');
            
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            pageData.forEach(item => {
                const row = document.createElement('tr');
                
                const hasTargets = item.data_source.targets !== '';
                const targetBadge = hasTargets 
                    ? `<span class="badge badge-success">‚úì Com Targets</span>`
                    : `<span class="badge badge-warning">‚ö† Sem Targets</span>`;

                // Determina cor da badge de vers√£o
                let versionBadge = '';
                const version = item.version || 'N/A';
                if (version.includes('12c') || version.includes('12.')) {
                    versionBadge = '<span class="badge badge-success">' + version + '</span>';
                } else if (version.includes('11') || version.includes('10')) {
                    versionBadge = '<span class="badge badge-warning">' + version + '</span>';
                } else if (version.includes('9')) {
                    versionBadge = '<span class="badge" style="background:#ffebee;color:#c62828;">' + version + '</span>';
                } else {
                    versionBadge = '<span class="badge" style="background:#e0e0e0;color:#666;">' + version + '</span>';
                }

                row.innerHTML = `
                    <td><strong>${item.server}</strong></td>
                    <td>${item.aplicacao || '-'}</td>
                    <td>${versionBadge}</td>
                    <td>${item.data_source.name}</td>
                    <td><code>${item.data_source.jndi_name}</code></td>
                    <td>${item.data_source.user}</td>
                    <td>${targetBadge}<br><small>${item.data_source.targets || '-'}</small></td>
                    <td class="url-cell" title="${item.data_source.jdbc_url}"><small>${item.data_source.jdbc_url}</small></td>
                `;
                
                tbody.appendChild(row);
            });

            table.style.display = 'table';
            pagination.style.display = 'flex';
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, filteredData.length);

            document.getElementById('paginationInfo').textContent = 
                `Mostrando ${startItem}-${endItem} de ${filteredData.length} registros`;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        function clearFilters() {
            document.getElementById('globalSearch').value = '';
            document.getElementById('filterServer').value = '';
            document.getElementById('filterApp').value = '';
            document.getElementById('filterVersion').value = '';
            document.getElementById('filterDSName').value = '';
            document.getElementById('filterJNDI').value = '';
            document.getElementById('filterUser').value = '';
            document.getElementById('filterURL').value = '';
            document.getElementById('filterTarget').value = '';
            applyFilters();
        }

        // Event listeners para filtros
        document.getElementById('globalSearch').addEventListener('input', applyFilters);
        document.getElementById('filterServer').addEventListener('input', applyFilters);
        document.getElementById('filterApp').addEventListener('input', applyFilters);
        document.getElementById('filterVersion').addEventListener('input', applyFilters);
        document.getElementById('filterDSName').addEventListener('input', applyFilters);
        document.getElementById('filterJNDI').addEventListener('input', applyFilters);
        document.getElementById('filterUser').addEventListener('input', applyFilters);
        document.getElementById('filterURL').addEventListener('input', applyFilters);
        document.getElementById('filterTarget').addEventListener('change', applyFilters);

        // Carrega dados ao iniciar
        loadData();
    </script>
</body>
</html>